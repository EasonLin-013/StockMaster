name: Deploy Frontend to GitHub Pages

on:
  push:
    branches: [ main ]
    paths:
      - 'StockWeb/**'
      - '.github/workflows/deploy-frontend.yml' # 腳本改動也觸發

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x

      - name: Publish Frontend
        # 這裡確保路徑正確
        run: dotnet publish StockWeb/StockWeb.csproj -c Release -o release

      - name: Fix Base Href and 404
        run: |
          # 強制將 index.html 裡的 base href 替換為專案路徑
          sed -i 's/<base href="\/" \/>/<base href="\/StockMaster\/" \/>/g' release/wwwroot/index.html
          # 複製 404.html 以支援 SPA 路由
          cp release/wwwroot/index.html release/wwwroot/404.html
          # 建立一個標記檔案確保知道是哪次部署
          echo "Deploy time: $(date)" > release/wwwroot/deploy-info.txt

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: release/wwwroot
          branch: gh-pages