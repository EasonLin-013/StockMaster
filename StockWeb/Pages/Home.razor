@page "/"
@using System.Text.Json
@inject HttpClient Http

<PageTitle>Data Terminal</PageTitle>

<div class="terminal">
    <div class="cmd-line">
        <span class="prefix">USER@DB:~$</span>
        <input @bind="stockCode" @onkeyup="HandleKeyUp" placeholder="system_id..." />
        <button @onclick="QueryStock">EXEC</button>
    </div>

    @if (rootData != null && rootData.msgArray.Any())
    {
        var d = rootData.msgArray[0];
        <div class="log-output">
            <div class="info-row">
                <span>[ID: @d.c]</span>
                <span>[INIT_S: @d.o]</span>
                <span>[MAX_V: @d.h]</span>
                <span>[MIN_V: @d.l]</span>
                <span class="highlight">[CURR_V: @d.z]</span>
            </div>

            <table class="grid">
                <thead>
                    <tr>
                        <th>RANK</th>
                        <th>BID_VAL (QTY)</th>
                        <th>ASK_VAL (QTY)</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        var bPrices = d.b?.Split('_');
                        var bQtys = d.g?.Split('_');
                        var aPrices = d.a?.Split('_');
                        var aQtys = d.f?.Split('_');
                    }
                    @for (int i = 0; i < 5; i++)
                    {
                        <tr>
                            <td>#0@(i+1)</td>
                            <td>@(GetVal(bPrices, i)) (@(GetVal(bQtys, i)))</td>
                            <td>@(GetVal(aPrices, i)) (@(GetVal(aQtys, i)))</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<style>
    :global(body) { background: #fff !important; color: #444 !important; font-family: monospace; }
    .terminal { padding: 15px; font-size: 12px; }
    .cmd-line { display: flex; gap: 5px; margin-bottom: 15px; }
    input { border: 1px solid #ddd; padding: 2px 5px; width: 80px; font-family: inherit; }
    button { background: #f0f0f0; border: 1px solid #ccc; cursor: pointer; font-size: 11px; }
    .log-output { border-top: 1px solid #eee; padding-top: 10px; }
    .info-row { margin-bottom: 10px; color: #666; display: flex; gap: 10px; flex-wrap: wrap; }
    .highlight { font-weight: bold; color: #000; }
    .grid { border-collapse: collapse; width: 100%; max-width: 450px; }
    th { text-align: left; background: #f9f9f9; color: #888; padding: 4px; font-weight: normal; border: 1px solid #eee; }
    td { padding: 4px; border: 1px solid #eee; }
</style>

@code {
    private string stockCode = "";
    private Root? rootData;
    private string apiBaseUrl = "https://stockmasterapi.onrender.com/api/stock/";

    private async Task QueryStock() {
        try {
            // 直接抓取原始 JSON，不做複雜轉換，避免崩潰
            rootData = await Http.GetFromJsonAsync<Root>($"{apiBaseUrl}{stockCode}");
        } catch { /* 靜默處理錯誤 */ }
    }

    private void HandleKeyUp(KeyboardEventArgs e) { if (e.Key == "Enter") QueryStock(); }
    private string GetVal(string[]? arr, int i) => (arr != null && arr.Length > i) ? arr[i] : "0";

    // 這裡的類別必須對應證交所原始的欄位名稱 (c, o, h, l, z...)
    public class Root { public List<Msg> msgArray { get; set; } = new(); }
    public class Msg {
        public string c { get; set; } = ""; // 代碼
        public string o { get; set; } = ""; // 開盤
        public string h { get; set; } = ""; // 最高
        public string l { get; set; } = ""; // 最低
        public string z { get; set; } = ""; // 現價
        public string b { get; set; } = ""; // 買價
        public string g { get; set; } = ""; // 買量
        public string a { get; set; } = ""; // 賣價
        public string f { get; set; } = ""; // 賣量
    }
}