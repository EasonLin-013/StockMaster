@page "/"
@using System.Text.Json
@inject HttpClient Http

<PageTitle>Data Terminal</PageTitle>

<div class="terminal-view">
    <div class="input-section">
        <span class="prefix">CMD></span>
        <input @bind="stockCode" @onkeyup="HandleKeyUp" placeholder="sys_code..." />
        <button @onclick="QueryStock">RUN</button>
    </div>

    @if (rootData != null && rootData.msgArray != null && rootData.msgArray.Any())
    {
        var d = rootData.msgArray[0];
        <div class="output-panel">
            <div class="meta-row">
                <span>[ID: @d.c]</span>
                <span>[INIT_S: @d.o]</span> <span>[MAX_V: @d.h]</span>  <span>[MIN_V: @d.l]</span>  <span class="bold">[CURR_V: @d.z]</span> </div>

            <table class="data-grid">
                <thead>
                    <tr>
                        <th>RANK</th>
                        <th>B_VAL (QTY)</th>
                        <th>A_VAL (QTY)</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        var bPrices = d.b?.Split('_');
                        var bQtys = d.g?.Split('_');
                        var aPrices = d.a?.Split('_');
                        var aQtys = d.f?.Split('_');
                    }
                    @for (int i = 0; i < 5; i++)
                    {
                        <tr>
                            <td class="gray">#0@(i + 1)</td>
                            <td>@(GetVal(bPrices, i)) (@(GetVal(bQtys, i)))</td>
                            <td>@(GetVal(aPrices, i)) (@(GetVal(aQtys, i)))</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<style>
    :global(body) { 
        background: #ffffff !important; 
        color: #333 !important; 
        font-family: 'Consolas', monospace; 
    }
    .terminal-view { padding: 15px; font-size: 12px; }
    .input-section { margin-bottom: 20px; display: flex; gap: 5px; align-items: center; }
    .prefix { color: #888; font-weight: bold; }
    input { border: 1px solid #ddd; padding: 2px 5px; width: 80px; outline: none; }
    button { background: #f0f0f0; border: 1px solid #ccc; padding: 2px 10px; cursor: pointer; font-size: 11px; }
    
    .meta-row { margin-bottom: 10px; color: #666; display: flex; gap: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
    .bold { color: #000; font-weight: bold; }
    .gray { color: #aaa; }

    .data-grid { border-collapse: collapse; width: 100%; max-width: 400px; }
    .data-grid th { text-align: left; background: #fafafa; color: #999; padding: 5px; font-weight: normal; border: 1px solid #eee; }
    .data-grid td { padding: 5px; border: 1px solid #eee; color: #444; }
</style>

@code {
    private string stockCode = "";
    private Root? rootData;
    private string apiBaseUrl = "https://stockmasterapi.onrender.com/api/stock/";

    private async Task QueryStock()
    {
        try {
            // 維持原本的抓取方式，不強迫轉換成自定義類別
            rootData = await Http.GetFromJsonAsync<Root>($"{apiBaseUrl}{stockCode}");
        } catch {
            // 靜默處理，不跳錯誤視窗
        }
    }

    private void HandleKeyUp(KeyboardEventArgs e) { if (e.Key == "Enter") QueryStock(); }
    private string GetVal(string[]? arr, int i) => (arr != null && arr.Length > i) ? arr[i] : "0";

    // 這些類別結構必須完全對應證交所原始 JSON 的名稱
    public class Root { public List<Msg>? msgArray { get; set; } }
    public class Msg {
        public string c { get; set; } = ""; // Code
        public string o { get; set; } = ""; // Open
        public string h { get; set; } = ""; // High
        public string l { get; set; } = ""; // Low
        public string z { get; set; } = ""; // Close
        public string b { get; set; } = ""; // Bid Prices
        public string g { get; set; } = ""; // Bid Vol
        public string a { get; set; } = ""; // Ask Prices
        public string f { get; set; } = ""; // Ask Vol
    }
}